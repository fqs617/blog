---
title: 业务中心版本控制思路
description: 业务中心独立于wbs，但最终是通过wbs来统一构建应用的，所以业务中心版本控制就显得很重要
banner: https://fs.newban.cc/img/2019/1/29/a31d8f7beb6e41e1a6ac967bb78ba1a1.jpg
author: 1306503317@qq.com
date: 2019-01-29 17:00
---

WBS采用了 WBS主系统 + WBS业务分中心 的方式来迭代业务，WBS会有一个大版本号，一般是跟产品的迭代版本号
保持同步，这个版本号主要控制WBS本身的改动以及这个版本所配套的各个业务中心的版本号。

正常情况下，如果一个WBS版本上线，那WBS里相关的业务中心的版本号就固定下来了，也就是说，一旦上线了，这个
WBS大版本里的所有版本都需要定下来，依赖包也不能删除，如果某个已上线版本出现问题，需要hotfix，可以把当前
版本的依赖包下载下来做处理，然后再发布对应的patch版本，或者checkout对应版本的tag到本地来hotfix.

举例说明：

WBS现在的版本是 `wbs2.0.0` ，所对应的WBS的分支是 `version2.0.0`，这个版本中配套有保险中心、展业中心和事务中心，
那对应的 `package.json` 版本信息如下：

```json
{
  "nb-vue-wbs-center-ins": "1.0.4",
  "nb-vue-wbs-center-lm": "1.0.1",
  "nb-vue-wbs-center-mc": "1.0.5",
}
```

这三个业务中心，在当前版本中的版本号是固定的，一旦系统上线到准生产或者生产，这个版本号就要被固定下来，不能在修改版本信息，同时分中心的repo要把对应版本的tag推送到远端已备份留存。

只有一种情况是可以临时修改版本信息，就是这个版本线上出现问题，需要hotfix，这个时候是可以修改版本号的，具体方法是：

* 把对应版本号的分中心依赖包 `tag` checkout到本地
* 修复问题，然后重新发布新版本的依赖包
* 更新wbs项目中package.json中该依赖包的版本号


## 补充说明

如果某个已上线分中心的版本号是 `1.0.3-7` ，这个时候该中心有新的迭代进来，
就需要再发布一个版本来维护迭代流程，比如叫 `1.0.4-0`，假如这个时候上一个版本线上有紧急bug，需要hotfix，
我们修复完bug发布新版本的时候一般是采用 `1.0.3-8` 这样来升级一个prerelease版本来fix线上的紧急问题。


## 约定规范

上边这种情况实际上是用版本号的 `patch` 位来控制大版本了，而实际上应该应该用 `major` 或 `minor` 比较合适。

复习下npm version的各个段位：

`major | minor | patch | pre-X`

比如 `1.0.5-3` ，1就是 `major` ，0就是 `minor`，5就是 `patch` ，3就是 `pre`，pre-major/minor/patch/release等等。


所以我们应该采用大版本号的方式来做。

* `major` 版本一般不变，除非有完全不兼容版本出现的时候变更大版本

* `minor` 版本为每次迭代的主版本，比如上次版本是 `1.0.1`，有新迭代的时候，新的版本就应该升级为 `1.1.0`，`minor` 升级，同时 `patch` 置零

* `patch` 版本来作为本次迭代周期内的小版本patch，或日常修复bug，或打补丁hotfix


举例说明：

wbs当前版本为 `wbs2.3.1`，对应的wbs的分支为 `version2.3.2`，这个版本中配套有保险中心、展业中心和事务中心，
那对应的 `package.json` 版本信息如下：

```json
{
  "nb-vue-wbs-center-ins": "1.0.4",
  "nb-vue-wbs-center-lm": "1.2.5",
  "nb-vue-wbs-center-mc": "1.0.5",
}
```

此时，事务中心 `nb-vue-wbs-center-lm` 启动了一个新的迭代周期，此时它的版本号就从当前的 `1.2.5` 升级为 `1.3.0`，lm这个周期内的开发任务都可以在 `1.3` 这个大的版本下进行。同时，需要从wbs的`version2.3.2`分支checkout一个新的分支 `version2.3.3` 来记录这次迭代的版本变更

在这一迭代周期内，如果上个版本 `1.2.5` 在准生产环境或者生产环境发现紧急bug，需要hotfix，就把 `1.2.5` 的tag checkout到本地，修复问题，然后升级一个patch版本 `1.2.6`，同时修改wbs `version2.3.2` 分支中package.json里lm的版本号为 `1.2.6`，至此完成一个hotfix。

当这个新功能的迭代周期开发测试完毕，需要上准生产/生产的时候，直接从wbs的 `version2.3.3` 分支打包上线即可，至此完成一个新的迭代周期。


## 核心点

* 新的功能迭代周期，wbs需要新建分支来记录该周期内的版本迭代信息

* 分中心每个迭代周期，需要分中心从 `minor` 开始升级版本号，同时 `patch` 置零

* 线上出问题需要hotfix，检出当前版本的tag，修复后升级对应的 `patch` 版本

* 依赖包一旦进入准生产或生产环境，禁止unpublish操作
